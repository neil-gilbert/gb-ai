name: Deploy App To Fasthosts

on:
  push:
    branches:
      - main
    paths:
      - "apps/web/**"
      - "package.json"
      - "package-lock.json"
      - "src/**"
      - "HyokaChat.sln"
      - ".github/workflows/deploy-api-fasthosts.yml"
  workflow_dispatch:

concurrency:
  group: deploy-app-fasthosts-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build And Upload Bundled App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Validate required secrets
        run: |
          test -n "${{ secrets.FASTHOSTS_FTP_HOST }}" || (echo "Missing FASTHOSTS_FTP_HOST" && exit 1)
          test -n "${{ secrets.FASTHOSTS_FTP_USERNAME }}" || (echo "Missing FASTHOSTS_FTP_USERNAME" && exit 1)
          test -n "${{ secrets.FASTHOSTS_FTP_PASSWORD }}" || (echo "Missing FASTHOSTS_FTP_PASSWORD" && exit 1)
          test -n "${{ secrets.PROVIDERS__OPENAI__API_KEY }}" || (echo "Missing PROVIDERS__OPENAI__API_KEY" && exit 1)
          test -n "${{ secrets.CONNECTIONSTRINGS__MYSQL }}" || (echo "Missing CONNECTIONSTRINGS__MYSQL" && exit 1)

      - name: Install web dependencies
        run: npm ci

      - name: Build static web export
        run: npm run build:web
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}

      - name: Publish API
        run: >
          dotnet publish src/Hyoka.Api/Hyoka.Api.csproj
          -c Release
          -r win-x64
          --self-contained false
          -p:PublishSingleFile=false
          -o output/api-publish

      - name: Bundle frontend assets into API wwwroot
        run: |
          mkdir -p output/api-publish/wwwroot
          cp -R apps/web/out/. output/api-publish/wwwroot/

      - name: Write appsettings.Production.json from secrets
        env:
          CONNECTIONSTRINGS__MYSQL: ${{ secrets.CONNECTIONSTRINGS__MYSQL }}
          CLERK__ISSUER: ${{ secrets.CLERK__ISSUER }}
          CLERK__AUDIENCE: ${{ secrets.CLERK__AUDIENCE }}
          STORAGE__SERVICEURL: ${{ secrets.STORAGE__SERVICEURL }}
          STORAGE__ACCESSKEY: ${{ secrets.STORAGE__ACCESSKEY }}
          STORAGE__SECRETKEY: ${{ secrets.STORAGE__SECRETKEY }}
          STORAGE__BUCKET: ${{ secrets.STORAGE__BUCKET }}
          STORAGE__USEPATHSTYLE: ${{ secrets.STORAGE__USEPATHSTYLE }}
          CORS__ALLOWEDORIGINS: ${{ secrets.CORS__ALLOWEDORIGINS }}
          DATABASE__SEEDONSTARTUP: ${{ secrets.DATABASE__SEEDONSTARTUP }}
          PROVIDERS__OPENAI__API_KEY: ${{ secrets.PROVIDERS__OPENAI__API_KEY }}
          PROVIDERS__OPENAI__BASEURL: ${{ secrets.PROVIDERS__OPENAI__BASEURL }}
          PROVIDERS__ANTHROPIC__API_KEY: ${{ secrets.PROVIDERS__ANTHROPIC__API_KEY }}
          PROVIDERS__ANTHROPIC__BASEURL: ${{ secrets.PROVIDERS__ANTHROPIC__BASEURL }}
          PROVIDERS__OPENROUTER__API_KEY: ${{ secrets.PROVIDERS__OPENROUTER__API_KEY }}
          PROVIDERS__OPENROUTER__BASEURL: ${{ secrets.PROVIDERS__OPENROUTER__BASEURL }}
          STRIPE__SECRETKEY: ${{ secrets.STRIPE__SECRETKEY }}
          STRIPE__WEBHOOKSECRET: ${{ secrets.STRIPE__WEBHOOKSECRET }}
          STRIPE__SUCCESSURL: ${{ secrets.STRIPE__SUCCESSURL }}
          STRIPE__CANCELURL: ${{ secrets.STRIPE__CANCELURL }}
        run: |
          jq -n \
            --arg mySql "$CONNECTIONSTRINGS__MYSQL" \
            --arg clerkIssuer "$CLERK__ISSUER" \
            --arg clerkAudience "$CLERK__AUDIENCE" \
            --arg storageServiceUrl "${STORAGE__SERVICEURL:-}" \
            --arg storageAccessKey "${STORAGE__ACCESSKEY:-}" \
            --arg storageSecretKey "${STORAGE__SECRETKEY:-}" \
            --arg storageBucket "${STORAGE__BUCKET:-}" \
            --arg storageUsePathStyle "${STORAGE__USEPATHSTYLE:-true}" \
            --arg corsAllowedOrigins "${CORS__ALLOWEDORIGINS:-https://gb-ai.co.uk,https://www.gb-ai.co.uk,http://localhost:3000,http://127.0.0.1:3000}" \
            --arg databaseSeedOnStartup "${DATABASE__SEEDONSTARTUP:-true}" \
            --arg openAiApiKey "$PROVIDERS__OPENAI__API_KEY" \
            --arg openAiBaseUrl "${PROVIDERS__OPENAI__BASEURL:-https://api.openai.com}" \
            --arg anthropicApiKey "${PROVIDERS__ANTHROPIC__API_KEY:-}" \
            --arg anthropicBaseUrl "${PROVIDERS__ANTHROPIC__BASEURL:-https://api.anthropic.com}" \
            --arg openRouterApiKey "${PROVIDERS__OPENROUTER__API_KEY:-}" \
            --arg openRouterBaseUrl "${PROVIDERS__OPENROUTER__BASEURL:-https://openrouter.ai/api}" \
            --arg stripeSecretKey "${STRIPE__SECRETKEY:-}" \
            --arg stripeWebhookSecret "${STRIPE__WEBHOOKSECRET:-}" \
            --arg stripeSuccessUrl "${STRIPE__SUCCESSURL:-}" \
            --arg stripeCancelUrl "${STRIPE__CANCELURL:-}" \
            '{
              ConnectionStrings: {
                MySql: $mySql
              },
              Cors: {
                AllowedOrigins: ($corsAllowedOrigins | split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length > 0)))
              },
              Database: {
                SeedOnStartup: (($databaseSeedOnStartup | ascii_downcase) == "true")
              },
              Clerk: {
                Issuer: $clerkIssuer,
                Audience: $clerkAudience
              },
              Storage: {
                ServiceUrl: $storageServiceUrl,
                AccessKey: $storageAccessKey,
                SecretKey: $storageSecretKey,
                Bucket: $storageBucket,
                UsePathStyle: (($storageUsePathStyle | ascii_downcase) == "true")
              },
              Providers: {
                OpenAI: {
                  BaseUrl: $openAiBaseUrl,
                  ApiKey: $openAiApiKey,
                  TimeoutSeconds: 120
                },
                Anthropic: {
                  BaseUrl: $anthropicBaseUrl,
                  ApiKey: $anthropicApiKey,
                  TimeoutSeconds: 120
                },
                OpenRouter: {
                  BaseUrl: $openRouterBaseUrl,
                  ApiKey: $openRouterApiKey,
                  TimeoutSeconds: 120
                }
              },
              Stripe: {
                SecretKey: $stripeSecretKey,
                WebhookSecret: $stripeWebhookSecret,
                SuccessUrl: $stripeSuccessUrl,
                CancelUrl: $stripeCancelUrl
              }
            }' > output/api-publish/appsettings.Production.json

      - name: Enable ASP.NET Core stdout logs for startup diagnostics
        run: |
          cat > output/api-publish/web.config <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <location path="." inheritInChildApplications="false">
              <system.webServer>
                <handlers>
                  <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
                </handlers>
              <httpErrors errorMode="DetailedLocalOnly" existingResponse="PassThrough" />
              <aspNetCore processPath=".\Hyoka.Api.exe" stdoutLogEnabled="true" stdoutLogFile=".\stdout" hostingModel="outofprocess">
                <environmentVariables>
                  <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                </environmentVariables>
              </aspNetCore>
            </system.webServer>
          </location>
          </configuration>
          EOF

      - name: Upload bundled app via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FASTHOSTS_FTP_HOST }}
          username: ${{ secrets.FASTHOSTS_FTP_USERNAME }}
          password: ${{ secrets.FASTHOSTS_FTP_PASSWORD }}
          protocol: ftps
          local-dir: output/api-publish/
          server-dir: ./
          state-name: ftp-deploy-sync-state-app.json
          dangerous-clean-slate: false
